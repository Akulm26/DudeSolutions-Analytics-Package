---
title: "Practicum Predictive"
author: "Team"
date: "3/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(tidyverse)
library(lubridate)
library(ggthemes)
library(data.table)
library(scales)
```

```{r new, cache=T}
newwo = read_csv("workorder_clean.csv", guess_max = 1500000)
```

### Data Manipulations

```{r date}
requested = newwo %>% 
  mutate(yearrequested = year(daterequested),
         monthrequested = month(daterequested),
         dayrequested = day(daterequested)) %>%
  filter(yearrequested < 2020, yearrequested > 2000) %>%
  mutate(ymrequested = make_date(yearrequested, monthrequested),
         ymdrequested = make_date(yearrequested, monthrequested, dayrequested)) %>%
  mutate(yearcompleted = year(actualcompletiondate),
         monthcompleted = month(actualcompletiondate),
         daycompleted = day(actualcompletiondate)) %>%
  filter(yearcompleted < 2020, yearcompleted > 2000) %>%
  mutate(ymcompleted = make_date(yearcompleted, monthcompleted),
         ymdcompleted = make_date(yearcompleted, monthcompleted, daycompleted))

```

```{r priorityts}
priority = requested %>% select(craftdescription, craftgroup, daterequested, datecreated, actualcompletiondate, laststatuschange, currentstatus, prioritydescription, ispreventmaint, ymrequested, ymcompleted) %>%
  filter(currentstatus %in% c("Completed", "Closed")) %>%
  filter(prioritydescription != "OTHER") %>%
  filter(!is.na(daterequested), !is.na(datecreated), !is.na(laststatuschange)) %>%
  mutate(createffi = abs(as.numeric(round((datecreated - daterequested)/3600), digits = 2)),
         totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

priority
```

### Cost Analysis

1. Subsets

```{r cost}
zerocost = newwo %>% filter(actualcosts == 0, 
                            currentstatus == "Completed") %>% 
  select(craftgroup, prioritydescription) %>%
  group_by(craftgroup) %>%
  summarize(n = n())

costdata = requested %>% filter(currentstatus %in% c("Completed", "Closed"),
                                !is.na(daterequested), 
                                !is.na(datecreated), 
                                !is.na(laststatuschange)) %>%
  filter(prioritydescription != "OTHER") %>%
  select(actualcosts, craftgroup, daterequested, actualcompletiondate, prioritydescription, ymrequested, ymcompleted) %>% 
  mutate(totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

zerocost = costdata %>% filter(actualcosts == 0)
nonzerocost = costdata %>% filter(actualcosts != 0)
normalcost = costdata %>% filter(actualcosts < 3500, actualcosts > 0)
mediumcost = costdata %>% filter(actualcosts >= 3500, actualcosts <= 10000)
highcost = costdata %>% filter(actualcosts > 10000)
```

2. Regression

```{r costreg}
regall = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = costdata)
summary(regall)

regnonzero = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = nonzerocost)
summary(regnonzero)

regnormal = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = normalcost)
summary(regnormal)

regmedium = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = mediumcost)
summary(regmedium)

reghigh = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = highcost)
summary(reghigh)
```

3. Time Series 


3.1. Time series by requested date to predict number of orders requested

```{r wocount}
wocount = nonzerocost  %>% group_by(ymrequested) %>% summarize(wocount = n())
```

```{r wocountts}
wocountts = ts(wocount$wocount, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(wocountts)
```

```{r wocountts_testMSE_allcrafts}
train.periods <- 160
test.periods <- length(wocountts) - train.periods
cycle <- 12

wocountts.training <- ts(wocount$wocount[1:train.periods], start = c(2001,1), end = c(2019,8), frequency = 12)

wocountts.training.SESmodel <- HoltWinters(wocountts.training, beta=FALSE, gamma=FALSE)
wocountts.training.DESmodel <- HoltWinters(wocountts.training, gamma=FALSE)
wocountts.training.HWmodel <- HoltWinters(wocountts.training)

wocountts.SESmodel <- HoltWinters(wocountts,
                          alpha=wocountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
wocountts.DESmodel <- HoltWinters(wocountts, 
                          alpha=wocountts.training.DESmodel$alpha, 
                          beta=wocountts.training.DESmodel$beta, 
                          gamma=FALSE)
wocountts.HWmodel <- HoltWinters(wocountts, 
                         alpha=wocountts.training.HWmodel$alpha, 
                         beta=wocountts.training.HWmodel$beta, 
                         gamma=wocountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((wocountts.SESmodel$fitted[fit.start:fit.end] - wocountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((wocountts.DESmodel$fitted[fit.start:fit.end] - wocountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((wocountts.HWmodel$fitted[fit.start:fit.end] - wocountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_allcrafts}
plot(wocountts.HWmodel)
wocount_2020_HW = forecast(wocountts.HWmodel, 15)
plot(wocount_2020_HW, main = "Holtwinters Forecast for 2019-2020")
```

To see the craft groups, use **unique(nonzerocost$craftgroup)**

3.1.2 Plumbing 

```{r wocountts_predict_plumbing}
plumbcount = nonzerocost %>% filter(craftgroup == "PLUMBING/RESTROOM") %>% 
  group_by(ymrequested) %>% 
  summarize(wocount = n())
#always filter first

plumbcountts = ts(plumbcount$wocount, start = c(2001,4), end = c(2019,6), frequency = 12)
plot(plumbcountts)
```

```{r wocountts_testMSE_plumb}
train.periods <- 160
test.periods <- length(plumbcountts) - train.periods


plumbcountts.training <- ts(plumbcount$wocount[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)

plumbcountts.training.SESmodel <- HoltWinters(plumbcountts.training, beta=FALSE, gamma=FALSE)
plumbcountts.training.DESmodel <- HoltWinters(plumbcountts.training, gamma=FALSE)
plumbcountts.training.HWmodel <- HoltWinters(plumbcountts.training)

plumbcountts.SESmodel <- HoltWinters(plumbcountts,
                          alpha=plumbcountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
plumbcountts.DESmodel <- HoltWinters(plumbcountts, 
                          alpha=plumbcountts.training.DESmodel$alpha, 
                          beta=plumbcountts.training.DESmodel$beta, 
                          gamma=FALSE)
plumbcountts.HWmodel <- HoltWinters(plumbcountts, 
                         alpha=plumbcountts.training.HWmodel$alpha, 
                         beta=plumbcountts.training.HWmodel$beta, 
                         gamma=plumbcountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((plumbcountts.SESmodel$fitted[fit.start:fit.end] - plumbcountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((plumbcountts.DESmodel$fitted[fit.start:fit.end] - plumbcountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((plumbcountts.HWmodel$fitted[fit.start:fit.end] - plumbcountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_plumb}
plot(plumbcountts.HWmodel)
plumbcount_2020_HW = forecast(plumbcountts.HWmodel, 15)
plot(plumbcount_2020_HW, main = "Holtwinters Plumbing Forecast for 2019-2020")
```

3.1.3 Furniture 

```{r wocountts_predict_furniture}
furniturecount = nonzerocost %>% filter(craftgroup == "FURNITURES/UTILITIES/APPLIANCES") %>% 
  group_by(ymrequested) %>% 
  summarize(wocount = n())
#always filter first

furniturecountts = ts(furniturecount$wocount, start = c(2001,4), end = c(2019,6), frequency = 12)
plot(furniturecountts)
```

```{r wocountts_testMSE_furniture}
train.periods = 160
test.periods = length(furniturecountts) - train.periods
cycle = 12

furniturecountts.training <- ts(furniturecount$wocount[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)

furniturecountts.training.SESmodel <- HoltWinters(furniturecountts.training, beta=FALSE, gamma=FALSE)
furniturecountts.training.DESmodel <- HoltWinters(furniturecountts.training, gamma=FALSE)
furniturecountts.training.HWmodel <- HoltWinters(furniturecountts.training)

furniturecountts.SESmodel <- HoltWinters(furniturecountts,
                          alpha=furniturecountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
furniturecountts.DESmodel <- HoltWinters(furniturecountts, 
                          alpha=furniturecountts.training.DESmodel$alpha, 
                          beta=furniturecountts.training.DESmodel$beta, 
                          gamma=FALSE)
furniturecountts.HWmodel <- HoltWinters(furniturecountts, 
                         alpha=furniturecountts.training.HWmodel$alpha, 
                         beta=furniturecountts.training.HWmodel$beta, 
                         gamma=furniturecountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((furniturecountts.SESmodel$fitted[fit.start:fit.end] - furniturecountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((furniturecountts.DESmodel$fitted[fit.start:fit.end] - furniturecountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((furniturecountts.HWmodel$fitted[fit.start:fit.end] - furniturecountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_furniture}
plot(furniturecountts.HWmodel)
furniturecount_2020_HW = forecast(furniturecountts.HWmodel, 15)
plot(furniturecount_2020_HW, main = "Holtwinters Furniture Forecast for 2019-2020")
```


3.1.3 Security 

```{r wocountts_predict_security}
securitycount = nonzerocost %>% filter(craftgroup == "HEALTH/SAFETY/SECURITY") %>% 
  group_by(ymrequested) %>% 
  summarize(wocount = n())

#always filter first  
  
securitycountts = ts(securitycount$wocount, start = c(2001,4), end = c(2019,6), frequency = 12)
plot(securitycountts)
```

```{r wocountts_testMSE_security}
train.periods = 160
test.periods = length(securitycountts) - train.periods
cycle = 12

securitycountts.training <- ts(securitycount$wocount[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)

securitycountts.training.SESmodel <- HoltWinters(securitycountts.training, beta=FALSE, gamma=FALSE)
securitycountts.training.DESmodel <- HoltWinters(securitycountts.training, gamma=FALSE)
securitycountts.training.HWmodel <- HoltWinters(securitycountts.training)

securitycountts.SESmodel <- HoltWinters(securitycountts,
                          alpha=securitycountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
securitycountts.DESmodel <- HoltWinters(securitycountts, 
                          alpha=securitycountts.training.DESmodel$alpha, 
                          beta=securitycountts.training.DESmodel$beta, 
                          gamma=FALSE)
securitycountts.HWmodel <- HoltWinters(securitycountts, 
                         alpha=securitycountts.training.HWmodel$alpha, 
                         beta=securitycountts.training.HWmodel$beta, 
                         gamma=securitycountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((securitycountts.SESmodel$fitted[fit.start:fit.end] - securitycountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((securitycountts.DESmodel$fitted[fit.start:fit.end] - securitycountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((securitycountts.HWmodel$fitted[fit.start:fit.end] - securitycountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_security}
plot(securitycountts.HWmodel)
securitycount_2020_HW = forecast(securitycountts.HWmodel, 15)
plot(securitycount_2020_HW, main = "Holtwinters Security Forecast for 2019-2020")
```

3.2. Time Series by requested date to predict total costs

```{r setupts}
costts = nonzerocost %>% 
  group_by(ymrequested) %>% 
  summarize(totalcost = sum(actualcosts))

#If the nonzerocost has extremes that ruin prediction, replace nonzerocost in 343 with normalcost
```

```{r costts}
totalts = ts(costts$totalcost, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(totalts)
```

### Priority Time Series



### Efficiency Time Series

1. Request-Created Efficiency

2. Request-Completed Efficiency
