---
title: "Practicum Predictive"
author: "Team"
date: "3/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(tidyverse)
library(lubridate)
library(ggthemes)
library(data.table)
library(scales)
library(forecast)
library(imputeTS)
```

```{r new, cache=T}
newwo = read_csv("workorder_clean.csv", guess_max = 1500000)
```

## Data Manipulations

```{r date}
requested = newwo %>% 
  mutate(yearrequested = year(daterequested),
         monthrequested = month(daterequested),
         dayrequested = day(daterequested)) %>%
  filter(yearrequested < 2020, yearrequested > 2000) %>%
  mutate(ymrequested = make_date(yearrequested, monthrequested),
         ymdrequested = make_date(yearrequested, monthrequested, dayrequested)) %>%
  mutate(yearcompleted = year(actualcompletiondate),
         monthcompleted = month(actualcompletiondate),
         daycompleted = day(actualcompletiondate)) %>%
  filter(yearcompleted < 2020, yearcompleted > 2000) %>%
  mutate(ymcompleted = make_date(yearcompleted, monthcompleted),
         ymdcompleted = make_date(yearcompleted, monthcompleted, daycompleted))

```

```{r priorityts}
priority = requested %>% select(craftdescription, craftgroup, daterequested, datecreated, actualcompletiondate, laststatuschange, currentstatus, prioritydescription, ispreventmaint, ymrequested, ymcompleted) %>%
  filter(currentstatus %in% c("Completed", "Closed")) %>%
  filter(prioritydescription != "OTHER") %>%
  filter(!is.na(daterequested), !is.na(datecreated), !is.na(laststatuschange)) %>%
  mutate(createffi = abs(as.numeric(round((datecreated - daterequested)/3600), digits = 2)),
         totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

priority
```

```{r emergencypriority ts}
emergencypriority = priority %>% filter(prioritydescription=="EMERGENCY") %>% 
                            select(prioritydescription, totaleffi, actualcompletiondate) %>% 
                            arrange(actualcompletiondate)
#view(emergencypriority)
e = ts(emergencypriority$totaleffi, start = c(2001,1), end = c(2019,12), frequency = 12)
plot(e)

train.emergency = 180
test.emergency = 48
e.cycle = 12

e.training = ts(emergencypriority$totaleffi[1:train.emergency], freq=e.cycle) 
e.training.SESmodel = HoltWinters(e.training, beta=FALSE, gamma=TRUE)
e.training.DESmodel = HoltWinters(e.training, gamma=TRUE)
e.training.HWmodel = HoltWinters(e.training)

e.SESmodel = HoltWinters(e, alpha=e.training.SESmodel$alpha, beta=FALSE, gamma=TRUE)
e.DESmodel = HoltWinters(e, alpha=e.training.DESmodel$alpha, beta=e.training.DESmodel$beta, gamma=TRUE)
e.HWmodel = HoltWinters(e, alpha=e.training.HWmodel$alpha, beta=e.training.HWmodel$beta, gamma=e.training.HWmodel$gamma)

e.data.start = train.emergency + 1
e.data.end = train.emergency + test.emergency

e.fit.start = train.emergency
e.fit.end = train.emergency + test.emergency - 1
e.SES.MSE = sum((e.SESmodel$fitted[e.fit.start:e.fit.end] - e[e.data.start:e.data.end])^2) / (test.emergency)
prediction.e.SES = predict(e.SESmodel, 60, prediction.interval = TRUE)
plot(e.SESmodel, prediction.e.SES, main = "Emergeny SES Model")

e.fit.start = train.emergency - 1
e.fit.end = train.emergency + test.emergency - 2
e.DES.MSE = sum((e.DESmodel$fitted[e.fit.start:e.fit.end] - e[e.data.start:e.data.end])^2) / (test.emergency)
prediction.e.DES = predict(e.DESmodel, 60, prediction.interval = TRUE)
plot(e.DESmodel, prediction.e.DES, main = "Emergency DES Model")

e.fit.start = train.emergency - e.cycle + 1
e.fit.end = train.emergency + test.emergency - e.cycle
e.HW.MSE = sum((e.HWmodel$fitted[e.fit.start:e.fit.end] - e[e.data.start:e.data.end])^2) / (test.emergency)
prediction.e.HW = predict(e.HWmodel, 60, prediction.interval = TRUE)
plot(e.HWmodel, prediction.e.HW, main = "Emergency HW Model")

cat(paste("SES MSE =",e.SES.MSE,"\nDES MSE =",e.DES.MSE,"\nHW MSE =",e.HW.MSE))
```

```{r highpriority ts}
highpriority = priority %>% filter(prioritydescription=="HIGH") %>% 
                            select(prioritydescription, totaleffi, actualcompletiondate) %>% 
                            arrange(actualcompletiondate)
#view(highpriority)
h = ts(highpriority$totaleffi, start = c(2001,1), end = c(2019,12), frequency = 12)
plot(h)

train.high = 180
test.high = 48
h.cycle = 12

h.training = ts(highpriority$totaleffi[1:train.high], start = c(2001,1), end = c(2019,12), freq=h.cycle) 
h.training.SESmodel = HoltWinters(h.training, beta=FALSE, gamma=TRUE)
h.training.DESmodel = HoltWinters(h.training, gamma=TRUE)
h.training.HWmodel = HoltWinters(h.training)

h.SESmodel = HoltWinters(h, alpha=h.training.SESmodel$alpha, beta=FALSE, gamma=TRUE)
h.DESmodel = HoltWinters(h, alpha=h.training.DESmodel$alpha, beta=h.training.DESmodel$beta, gamma=TRUE)
h.HWmodel = HoltWinters(h, alpha=h.training.HWmodel$alpha, beta=h.training.HWmodel$beta, gamma=h.training.HWmodel$gamma)

h.data.start = train.high + 1
h.data.end = train.high + test.high

h.fit.start = train.high
h.fit.end = train.high + test.high - 1
h.SES.MSE = sum((h.SESmodel$fitted[h.fit.start:h.fit.end] - h[h.data.start:h.data.end])^2) / (test.high)
prediction.h.SES = predict(h.SESmodel, 60, prediction.interval = TRUE)
plot(h.SESmodel, prediction.h.SES, main = "High SES Model")

h.fit.start = train.high - 1
h.fit.end = train.high + test.high - 2
h.DES.MSE = sum((h.DESmodel$fitted[h.fit.start:h.fit.end] - h[h.data.start:h.data.end])^2) / (test.high)
prediction.h.DES = predict(h.DESmodel, 60, prediction.interval = TRUE)
plot(h.DESmodel, prediction.h.DES, main = "High DES Model")

h.fit.start = train.high - h.cycle + 1
h.fit.end = train.high + test.high - h.cycle
h.HW.MSE = sum((h.HWmodel$fitted[h.fit.start:h.fit.end] - h[h.data.start:h.data.end])^2) / (test.high)
prediction.h.HW = predict(h.HWmodel, 60, prediction.interval = TRUE)
plot(h.HWmodel, prediction.h.HW, main = "High HW Model")

cat(paste("SES MSE =",h.SES.MSE,"\nDES MSE =",h.DES.MSE,"\nHW MSE =",h.HW.MSE))
```

```{r mediumpriority ts}
mediumpriority = priority %>% filter(prioritydescription=="MEDIUM") %>% 
                              select(prioritydescription, totaleffi, actualcompletiondate) %>% 
                              arrange(actualcompletiondate)
#view(mediumpriority)
m = ts(mediumpriority$totaleffi, start = c(2001,1), end = c(2019,12), frequency = 12)
plot(m)

train.medium = 180
test.medium = 48
m.cycle = 12

m.training = ts(mediumpriority$totaleffi[1:train.medium], start = c(2001,1), end = c(2019,12), freq=m.cycle) 
m.training.SESmodel = HoltWinters(m.training, beta=FALSE, gamma=TRUE)
m.training.DESmodel = HoltWinters(m.training, gamma=TRUE)
m.training.HWmodel = HoltWinters(m.training)

m.SESmodel = HoltWinters(m, alpha=m.training.SESmodel$alpha, beta=FALSE, gamma=TRUE)
m.DESmodel = HoltWinters(m, alpha=m.training.DESmodel$alpha, beta=m.training.DESmodel$beta, gamma=TRUE)
m.HWmodel = HoltWinters(m, alpha=m.training.HWmodel$alpha, beta=m.training.HWmodel$beta, gamma=m.training.HWmodel$gamma)

m.data.start = train.medium + 1
m.data.end = train.medium + test.medium

m.fit.start = train.medium
m.fit.end = train.medium + test.medium - 1
m.SES.MSE = sum((m.SESmodel$fitted[m.fit.start:m.fit.end] - m[m.data.start:m.data.end])^2) / (test.medium)
prediction.m.SES = predict(m.SESmodel, 60, prediction.interval = TRUE)
plot(m.SESmodel, prediction.m.SES, main = "Medium SES Model")

m.fit.start = train.medium - 1
m.fit.end = train.medium + test.medium - 2
m.DES.MSE = sum((m.DESmodel$fitted[m.fit.start:m.fit.end] - m[m.data.start:m.data.end])^2) / (test.medium)
prediction.m.DES = predict(m.DESmodel, 60, prediction.interval = TRUE)
plot(m.DESmodel, prediction.m.DES, main = "Medium Priority DES Model")

m.fit.start = train.medium - m.cycle + 1
m.fit.end = train.medium + test.medium - m.cycle
m.HW.MSE = sum((m.HWmodel$fitted[m.fit.start:m.fit.end] - m[m.data.start:m.data.end])^2) / (test.medium)
prediction.m.HW = predict(m.HWmodel, 60, prediction.interval = TRUE)
plot(m.HWmodel, prediction.m.HW, main = "Medium Priority HW Model")

cat(paste("SES MSE =",m.SES.MSE,"\nDES MSE =",m.DES.MSE,"\nHW MSE =",m.HW.MSE))
```

```{r lowpriority ts}
lowpriority = priority %>% filter(prioritydescription=="LOW") %>% 
                           select(prioritydescription, totaleffi, actualcompletiondate) %>% 
                           arrange(actualcompletiondate)
#view(lowpriority)
l = ts(lowpriority$totaleffi, start = c(2001,1), end = c(2019,12), frequency = 12)
plot(l)

train.low = 180
test.low = 48
l.cycle = 12

l.training = ts(lowpriority$totaleffi[1:train.low], start = c(2001,1), end = c(2019,12), freq=l.cycle) 
l.training.SESmodel = HoltWinters(l.training, beta=FALSE, gamma=TRUE)
l.training.DESmodel = HoltWinters(l.training, gamma=TRUE)
l.training.HWmodel = HoltWinters(l.training)

l.SESmodel = HoltWinters(l, alpha=l.training.SESmodel$alpha, beta=FALSE, gamma=TRUE)
l.DESmodel = HoltWinters(l, alpha=l.training.DESmodel$alpha, beta=l.training.DESmodel$beta, gamma=TRUE)
l.HWmodel = HoltWinters(l, alpha=l.training.HWmodel$alpha, beta=l.training.HWmodel$beta, gamma=l.training.HWmodel$gamma)

l.data.start = train.low + 1
l.data.end = train.low + test.low

l.fit.start = train.low
l.fit.end = train.low + test.low - 1
l.SES.MSE = sum((l.SESmodel$fitted[l.fit.start:l.fit.end] - l[l.data.start:l.data.end])^2) / (test.low)
prediction.l.SES = predict(l.SESmodel, 60, prediction.interval = TRUE)
plot(l.SESmodel, prediction.l.SES, main = "Low SES Model")

l.fit.start = train.low - 1
l.fit.end = train.low + test.low - 2
l.DES.MSE = sum((l.DESmodel$fitted[l.fit.start:l.fit.end] - l[l.data.start:l.data.end])^2) / (test.low)
prediction.l.DES = predict(l.DESmodel, 60, prediction.interval = TRUE)
plot(l.DESmodel, prediction.l.DES, main = "Low DES Model")

l.fit.start = train.low - l.cycle + 1
l.fit.end = train.low + test.low - l.cycle
l.HW.MSE = sum((l.HWmodel$fitted[l.fit.start:l.fit.end] - l[l.data.start:l.data.end])^2) / (test.low)
prediction.l.HW = predict(l.HWmodel, 60, prediction.interval = TRUE)
plot(l.HWmodel, prediction.l.HW, main = "Low HW Model")

cat(paste("SES MSE =",l.SES.MSE,"\nDES MSE =",l.DES.MSE,"\nHW MSE =",l.HW.MSE))
```

## Cost Analysis

### 1. Subsets

```{r cost}
zerocost = newwo %>% filter(actualcosts == 0, 
                            currentstatus == "Completed") %>% 
  select(craftgroup, prioritydescription) %>%
  group_by(craftgroup) %>%
  summarize(n = n())

costdata = requested %>% filter(currentstatus %in% c("Completed", "Closed"),
                                !is.na(daterequested), 
                                !is.na(datecreated), 
                                !is.na(laststatuschange)) %>%
  filter(prioritydescription != "OTHER") %>%
  select(actualcosts, craftgroup, daterequested, actualcompletiondate, prioritydescription, ymrequested, ymcompleted) %>% 
  mutate(totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

zerocost = costdata %>% filter(actualcosts == 0)
nonzerocost = costdata %>% filter(actualcosts != 0)
normalcost = costdata %>% filter(actualcosts < 3500, actualcosts > 0)
mediumcost = costdata %>% filter(actualcosts >= 3500, actualcosts <= 10000)
highcost = costdata %>% filter(actualcosts > 10000)
```

### 2. Regression

```{r costreg}
regall = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = costdata)
summary(regall)

regnonzero = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = nonzerocost)
summary(regnonzero)

regnormal = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = normalcost)
summary(regnormal)

regmedium = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = mediumcost)
summary(regmedium)

reghigh = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = highcost)
summary(reghigh)
```

### 3. Time Series 

#### Functions

```{r MSEfunc}

#The following functions are used to identify the time series method that gives the lowest test MSE

##For Number of Work Orders by Craft Group

COUNT_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)

  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=FALSE)
  ts.training.DESmodel <- HoltWinters(ts.training, gamma=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                                       alpha=ts.training.SESmodel$alpha, 
                                       beta=FALSE, 
                                       gamma=FALSE)
  ts.DESmodel <- HoltWinters(ts, 
                                       alpha=ts.training.DESmodel$alpha, 
                                       beta=ts.training.DESmodel$beta, 
                                       gamma=FALSE)
  ts.HWmodel <- HoltWinters(ts, 
                                      alpha=ts.training.HWmodel$alpha, 
                                      beta=ts.training.HWmodel$beta, 
                                      gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - 1 
  fit.end <- train.periods + test.periods - 2
  
  DES.MSE <- sum((ts.DESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
  
}

#For Total Cost of Work Orders in each Craft Group

COST_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=FALSE)
  ts.training.DESmodel <- HoltWinters(ts.training, gamma=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=FALSE)
  ts.DESmodel <- HoltWinters(ts, 
                             alpha=ts.training.DESmodel$alpha, 
                             beta=ts.training.DESmodel$beta, 
                             gamma=FALSE)
  ts.HWmodel <- HoltWinters(ts, 
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - 1 
  fit.end <- train.periods + test.periods - 2
  
  DES.MSE <- sum((ts.DESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
  
}
```

```{r predSES}
SES.prediction = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=FALSE)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=FALSE)
  
  forec = forecast(ts.SESmodel, 18)
  SES.plot = plot(ts.SESmodel)
  forecast.plot = plot(forec, main = "Single Exponential Smoothing Forecast for 2019-2020")
  forecast.plot
  
}
```

```{r predDES}
DES.prediction = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.DESmodel <- HoltWinters(ts.training, gamma=FALSE)
  
  ts.DESmodel <- HoltWinters(ts,
                             alpha=ts.training.DESmodel$alpha, 
                             beta=ts.training.DESmodel$beta, 
                             gamma=FALSE)
  
  forec = forecast(ts.DESmodel, 18)
  DES.plot = plot(ts.DESmodel)
  forecast.plot = plot(forec, main = "Double Exponential Smoothing Forecast for 2019-2020")
  forecast.plot
  
}
```

```{r predHW}
HW.prediction = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.HWmodel <- HoltWinters(ts,
                             alpha=ts.training.HWmodel$alpha, 
                             beta=ts.training.HWmodel$beta, 
                             gamma=ts.training.HWmodel$gamma)
  
  forec = forecast(ts.HWmodel, 18)
  HW.plot = plot(ts.HWmodel)
  forecast.plot = plot(forec, main = "Holtwinter Seasonality Forecast for 2019-2020")
  list(HW.plot, forecast.plot)
  
}
```

#### 3.1. Time series by requested date to predict number of orders requested

**3.1.1 All Orders for All Crafts**

```{r wocount}
wocount = nonzerocost  %>% group_by(ymrequested) %>% summarize(wocount = n())
```

```{r wocountts}
wocountts = ts(wocount$wocount, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(wocountts)
```

```{r wocountts_testMSE_allcrafts}
train.periods <- 155
test.periods <- length(wocountts) - train.periods
cycle <- 12

wocountts.training <- ts(wocount$wocount[1:train.periods], start = c(2001,1), end = c(2019,8), frequency = 12)

wocountts.training.SESmodel <- HoltWinters(wocountts.training, beta=FALSE, gamma=FALSE)
wocountts.training.DESmodel <- HoltWinters(wocountts.training, gamma=FALSE)
wocountts.training.HWmodel <- HoltWinters(wocountts.training)

wocountts.SESmodel <- HoltWinters(wocountts,
                          alpha=wocountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
wocountts.DESmodel <- HoltWinters(wocountts, 
                          alpha=wocountts.training.DESmodel$alpha, 
                          beta=wocountts.training.DESmodel$beta, 
                          gamma=FALSE)
wocountts.HWmodel <- HoltWinters(wocountts, 
                         alpha=wocountts.training.HWmodel$alpha, 
                         beta=wocountts.training.HWmodel$beta, 
                         gamma=wocountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((wocountts.SESmodel$fitted[fit.start:fit.end] - wocountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((wocountts.DESmodel$fitted[fit.start:fit.end] - wocountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((wocountts.HWmodel$fitted[fit.start:fit.end] - wocountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_allcrafts}
plot(wocountts.HWmodel)
wocount_2020_HW = forecast(wocountts.HWmodel, 15)
plot(wocount_2020_HW, main = "Holtwinters Forecast for 2019-2020")
```

**3.1.2 Plumbing** 

```{r wocountts_predict_plumb}
COUNT_COUNT_TS_MSE("PLUMBING/RESTROOM")

HW.prediction("PLUMBING/RESTROOM")
```

**3.1.3 Furniture** 

```{r wocountts_predict_furniture}
COUNT_TS_MSE("FURNITURES/UTILITIES/APPLIANCES")

HW.prediction("FURNITURES/UTILITIES/APPLIANCES")
```


**3.1.3 Security**

```{r wocountts_predict_security}
COUNT_TS_MSE("HEALTH/SAFETY/SECURITY")

HW.prediction("HEALTH/SAFETY/SECURITY")
```

**3.1.4 Electricity/Energy**

```{r wocountts_predict_energy}
COUNT_TS_MSE("ELECTRICITY/ENERGY")

HW.prediction("ELECTRICITY/ENERGY")
```

**3.1.5 Outdoors**

```{r wocountts_predict_outdoor}
COUNT_TS_MSE("OUTDOORS")

HW.prediction("OUTDOORS")
```

**3.1.6 Vehicle/Transportation/Delivery** 

```{r wocountts_predict_transport}
COUNT_TS_MSE("VEHICLE/TRANSPORTATION/DELIVERY")

DES.prediction("VEHICLE/TRANSPORTATION/DELIVERY")
```

**3.1.7 Cleaning/Sanitization** 

```{r wocountts_predict_clean}
COUNT_TS_MSE("CLEANING/SANITIZATION")

DES.prediction("CLEANING/SANITIZATION")
```

**3.1.8 Construction/Building** 

```{r wocountts_predict_construct}
COUNT_TS_MSE("CONSTRUCTION/BUILDING")

DES.prediction("CONSTRUCTION/BUILDING")
```


**3.1.9 Event/Recreation/Food and Beverages**

```{r wocountts_predict_event}
COUNT_TS_MSE("EVENT/RECREATION/F&B")

HW.prediction("EVENT/RECREATION/F&B")
```


**3.1.10 Plant and Materials**

```{r wocountts_predict_plant}
COUNT_TS_MSE("PLANT/MATERIALS")

HW.prediction("PLANT/MATERIALS")
```

**3.1.11 Personnel and Training**

```{r wocountts_predict_personnel}
COUNT_TS_MSE("ADMIN/PERSONNEL/TRAINING")

DES.prediction("ADMIN/PERSONNEL/TRAINING")
```

**3.1.12 Preventive/Scheduled** 

```{r wocountts_predict_PM}
COUNT_TS_MSE("PREVENTIVE/SCHEDULED")

SES.prediction("PREVENTIVE/SCHEDULED")
```

**3.1.13 Inspection** 

```{r wocountts_predict_inspect}
COUNT_TS_MSE("INSPECTION")

DES.prediction("INSPECTION")
```

**3.1.14 IT/Network** 

```{r wocountts_predict_IT}
COUNT_TS_MSE("IT/NETWORK")

HW.prediction("IT/NETWORK")
```


**3.1.15 Contract**

```{r wocountts_predict_contract}
COUNT_TS_MSE("CONTRACT")

SES.prediction("CONTRACT")
```

**3.1.16 SOS**

```{r wocountts_predict_SOS}
COUNT_TS_MSE("SOS")

SES.prediction("SOS")
```


**3.1.17 Others** 

```{r wocountts_predict_other}
othercount = nonzerocost %>% filter(craftgroup %in% c("CODES", "OTHER", "UNCLEAR/TBD")) %>% 
  group_by(ymrequested) %>% 
  summarize(wocount = n())
othercountts = ts(othercount$wocount, start = c(2001,4), end = c(2019,6), frequency = 12)
plot(othercountts)
```

```{r wocountts_testMSE_other}
test.periods <- length(othercountts) - train.periods

othercountts.training <- ts(othercount$wocount[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)

othercountts.training.SESmodel <- HoltWinters(othercountts.training, beta=FALSE, gamma=FALSE)
othercountts.training.DESmodel <- HoltWinters(othercountts.training, gamma=FALSE)
othercountts.training.HWmodel <- HoltWinters(othercountts.training)

othercountts.SESmodel <- HoltWinters(othercountts,
                          alpha=othercountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
othercountts.DESmodel <- HoltWinters(othercountts, 
                          alpha=othercountts.training.DESmodel$alpha, 
                          beta=othercountts.training.DESmodel$beta, 
                          gamma=FALSE)
othercountts.HWmodel <- HoltWinters(othercountts, 
                         alpha=othercountts.training.HWmodel$alpha, 
                         beta=othercountts.training.HWmodel$beta, 
                         gamma=othercountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((othercountts.SESmodel$fitted[fit.start:fit.end] - othercountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((othercountts.DESmodel$fitted[fit.start:fit.end] - othercountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((othercountts.HWmodel$fitted[fit.start:fit.end] - othercountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_other}
plot(othercountts.HWmodel)
othercount_2020_HW = forecast(othercountts.HWmodel, 15)
plot(othercount_2020_HW, main = "Holtwinters other Forecast for 2019-2020")
```

3.2. Time Series by requested date to predict total costs

```{r setupts}
costts = nonzerocost %>% 
  group_by(ymrequested) %>% 
  summarize(totalcost = sum(actualcosts))

normalcostts = normalcost %>% select(actualcosts, ymrequested)
mediumcostts = mediumcost %>% select(actualcosts, ymrequested)
highcostts = highcost %>% select(actualcosts, ymrequested)
```

```{r costts}
totalts = ts(costts$totalcost, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(totalts)
```

```{r costfunctions}
COST_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle = 12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=FALSE)
  ts.training.DESmodel <- HoltWinters(ts.training, gamma=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=FALSE)
  ts.DESmodel <- HoltWinters(ts, 
                             alpha=ts.training.DESmodel$alpha, 
                             beta=ts.training.DESmodel$beta, 
                             gamma=FALSE)
  ts.HWmodel <- HoltWinters(ts, 
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - 1 
  fit.end <- train.periods + test.periods - 2
  
  DES.MSE <- sum((ts.DESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
  
}

### SES function for cost

SES.prediction.cost = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts)) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle = 12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=FALSE)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=FALSE)
  
  forec = forecast(ts.SESmodel, 18)
  SES.plot = plot(ts.SESmodel)
  forecast.plot = plot(forec, main = "Single Exponential Smoothing Cost Forecast for 2019-2020")
  list(SES.plot, forecast.plot)
  
}

###DES function for cost

DES.prediction.cost = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts)) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle = 12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.DESmodel <- HoltWinters(ts.training, gamma=FALSE)
  
  ts.DESmodel <- HoltWinters(ts,
                             alpha=ts.training.DESmodel$alpha, 
                             beta=ts.training.DESmodel$beta, 
                             gamma=FALSE)
  
  forec = forecast(ts.DESmodel, 18)
  DES.plot = plot(ts.DESmodel)
  forecast.plot = plot(forec, main = "Double Exponential Smoothing Cost Forecast for 2019-2020")
  forecast.plot
  
}

### HW function for cost

HW.prediction.cost = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts)) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.HWmodel <- HoltWinters(ts,
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  forec = forecast(ts.HWmodel, 18)
  HW.plot = plot(ts.HWmodel)
  forecast.plot = plot(forec, main = "Holtwinter Seasonality Cost Forecast for 2019-2020")
  list(HW.plot, forecast.plot)
  
}
```

### 4. Priority Time Series



### 5. Efficiency Time Series

1. Request-Created Efficiency

2. Request-Completed Efficiency
