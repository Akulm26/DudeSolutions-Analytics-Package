---
title: "Practicum Data Cleaning"
author: "Anh Do"
date: "November 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```

```{r library}
library(tidyverse)
library(lubridate)
library(ggthemes)
library(data.table)
library(scales)
```

```{r new, cache=T}
newwo = read_csv("workorder_grouped.csv", guess_max = 1500000)
```

1. Requested Date

#For time series, useful for descriptive but may not be useful for predictive unless we do per account

```{r requestdate}
requested = newwo %>% 
  mutate(yearrequested = year(daterequested),
         monthrequested = month(datecreated),
         dayrequested = day(datecreated)) %>%
  filter(yearrequested < 2020, yearrequested > 2000) %>%
  mutate(ymrequested = make_date(yearrequested, monthrequested),
         ymdrequested = make_date(yearrequested, monthrequested, dayrequested)) 

request_count = requested %>%
  group_by(ymrequested) %>%
  summarize(count = n())
request_count

request_craft = requested %>%
  group_by(craftgroup, ymrequested) %>%
  summarise(count = n()) 
request_craft

request_customer = requested %>%
  group_by(ymdrequested, dudecustomerid) %>%
  summarize(count = n()) %>%
  arrange(dudecustomerid)
request_customer
```

```{r requestts}
request_craft %>% 
  ggplot(aes(x=ymrequested, y=count)) +
  geom_line() + theme_few()
```

2. Cost per Craft group

```{r cost}
cost_craft = newwo %>% filter(actualcosts < 1000000000) %>%
  group_by(craftgroup) %>%
  summarise(TotalCost = round(sum(actualcosts)/1000000, digits = 4)) %>%
  arrange(desc(TotalCost)) %>% 
  ggplot(aes(x=reorder(craftgroup, TotalCost), y=TotalCost)) + 
  geom_bar(stat="identity") +
  guides(fill=F) +
  coord_flip() +
  theme_few() +
  labs(title="Total Cost per Craft Group", 
       y="Total Cost (in Million)", 
       x="") +
  theme(title = element_text(face="bold"), 
        axis.title = element_text(face="bold"),
        panel.border = element_blank(), 
        axis.line.x = element_line(colour="grey80"), 
        axis.line.y = element_line(colour="grey80"),
        axis.ticks  = element_blank()) +
  scale_y_continuous(labels = dollar)
  
cost_craft

high_furniture_cost = newwo %>% filter(craftgroup == "FURNITURES/UTILITIES/APPLIANCES") %>%
  group_by(craftdescription) %>%
  summarise(TotalCost = round(sum(actualcosts)/1000000, digits = 4)) %>%
  arrange(desc(TotalCost)) %>% 
  filter(TotalCost > 10) %>%
  ggplot(aes(x=reorder(craftdescription, TotalCost), y=TotalCost)) + 
  geom_bar(stat="identity") +
  guides(fill=F) +
  coord_flip() +
  theme_few() +
  labs(title="Most expensive crafts under Furniture/Utilities/Appliances", 
       y="Total Cost (in Million)", 
       x="") +
  theme(title = element_text(face="bold", size = 10), 
        axis.title = element_text(face="bold"),
        panel.border = element_blank(), 
        axis.line.x = element_line(colour="grey80"), 
        axis.line.y = element_line(colour="grey80"),
        axis.ticks  = element_blank()) +
  scale_y_continuous(labels = dollar)

```

3. Cost per Asset ID

Most assets cost less than $1000.

```{r statuscount}
cost_asset = newwo %>%
  filter(!is.na(assetid), assetid > 0) %>%
  group_by(assetid) %>%
  summarise(TotalCost = round(sum(actualcosts))) %>%
  arrange(desc(TotalCost)) 

print(paste("There are", length(unique(cost_asset$assetid)), "unique assets."))

asset_cost_histogram = cost_asset %>% 
  ggplot(aes(x = TotalCost)) + 
  geom_histogram() + 
  theme_few() +
  labs(title="Asset cost Distribution", 
       x="Total Cost", 
       y="Number of Assets")

expensive_asset = cost_asset %>% 
  filter(TotalCost >= 100000) %>% 
  ggplot(aes(x = TotalCost)) + 
  geom_histogram() + 
  theme_few() +
  labs(title="Distribution of Most expensive Asset", 
       x="Total Cost (in Million)", 
       y="Number of Assets")

normal_asset = cost_asset %>% 
  filter(TotalCost < 2000) %>% 
  ggplot(aes(x = TotalCost)) + 
  geom_histogram() + 
  theme_few() +
  labs(title="Distribution of Assets with total cost less than $2000", 
       x="Total Cost", 
       y="Number of Assets")

asset_cost_histogram
expensive_asset
normal_asset
```

4. Count Reactive/Preventive Craft Group

#preventive is one of the craft groups which may be confusing

```{r pmcraft}
pm_craft = newwo %>%
  group_by(craftgroup) %>%
  summarise(Count = round(sum(ispreventmaint)/1000, digits = 2)) %>%
  arrange(desc(Count)) %>% 
  ggplot(aes(x=reorder(craftgroup, Count), y=Count)) + 
  geom_bar(stat="identity") +
  guides(fill=F) +
  coord_flip() +
  theme_few() +
  labs(title="Number of Preventive Maintenance per Craft Group", 
       y="Total Number of Work Orders", 
       x="") +
  theme(title = element_text(face="bold", size=10), 
        axis.title = element_text(face="bold"),
        panel.border = element_blank(), 
        axis.line.x = element_line(colour="grey80"), 
        axis.line.y = element_line(colour="grey80"),
        axis.ticks  = element_blank()) +
  scale_y_continuous(labels = dollar)
pm_craft
```

5. Count Reactive/Preventive Asset ID

We look at the first 6 assets with the highest number of preventive maintenance work orders, and the first 6 assets with the highest average cost per preventive maintenance work orders, since these are the outliers. We plan to perform time series for these 12.

```{r pmasset}
pm_asset = newwo %>%
  filter(!is.na(assetid), assetid > 0, ispreventmaint == 1) %>%
  group_by(assetid) %>%
  summarise(Count = sum(ispreventmaint),
            AverageCost = round(mean(actualcosts), digits = 4)) %>%
  arrange(assetid)

plot(pm_asset$Count, pm_asset$AverageCost, xlab = "Number of preventive maintenance work orders", ylab = "Average Cost in Dollar")

pm_asset %>% 
  arrange(desc(Count)) %>%
  head()

pm_asset %>%
  arrange(desc(AverageCost)) %>%
  head()  

```

by priority description, by craft, by efficiency (predict efficiency based on craftgroup, priority, ispreventmaint - regression, tree)

```{r date}
requested = newwo %>% 
  mutate(yearrequested = year(daterequested),
         monthrequested = month(daterequested),
         dayrequested = day(daterequested)) %>%
  filter(yearrequested < 2020, yearrequested > 2000) %>%
  mutate(ymrequested = make_date(yearrequested, monthrequested),
         ymdrequested = make_date(yearrequested, monthrequested, dayrequested)) %>%
  mutate(yearcompleted = year(actualcompletiondate),
         monthcompleted = month(actualcompletiondate),
         daycompleted = day(actualcompletiondate)) %>%
  filter(yearcompleted < 2020, yearcompleted > 2000) %>%
  mutate(ymcompleted = make_date(yearcompleted, monthcompleted),
         ymdcompleted = make_date(yearcompleted, monthcompleted, daycompleted))

```

```{r priorityts}
priority = requested %>% select(craftdescription, craftgroup, daterequested, datecreated, actualcompletiondate, laststatuschange, currentstatus, prioritydescription, ispreventmaint, ymrequested, ymcompleted) %>%
  filter(currentstatus != "Others") %>%
  filter(!(prioritydescription %in% c("-", "TBD", "Safety", "unknown", "Some Production Loss", "System Available", "Spare Time"))) %>%
  filter(!is.na(daterequested), !is.na(datecreated), !is.na(laststatuschange)) %>%
  mutate(createffi = as.numeric(round((datecreated - daterequested)/3600, digits = 2)),
         totaleffi = as.numeric(round((actualcompletiondate - daterequested)/3600, digits = 2))) %>%
  filter(totaleffi >= 0, createffi >= 0)

priority
```

```{r prioritydescription}
newwo$prioritydescription = as.character(newwo$prioritydescription)
newwo = newwo %>% 
  filter(prioritydescription != "") %>%
  mutate(prioritydescription = replace(prioritydescription, prioritydescription %in% 
                                                      c("Safety","Critical","emergency","Critical - Immediate Response","Rush","Urgent","Critical - (Immediate)","Safety Emergency","Critical - Down","Critical (1- 2 hours)","urgent","safety","Production Line Down","Critical - Safety","A_Urgent-Critical_2 hrs","EMERGENCY W/I 2 HOURS PLEASE CALL","Emergency After-hours W/I 2 HOURS","WP - URGENT","WP - EMERGENCY","Critical; Immediate Response","1 - Critical: Important and Urgent","Safety Related","Emergency"), 
                                                      "Emergency"),
                         prioritydescription = replace(prioritydescription,
                                                       prioritydescription %in% c("high - resp. 1 hr.","very high - respond","High - (ASAP - 24 Hours)","High (2- 4 hours)","High","High- Within 3 Business Days","High Priority","High; 2 days","High - Same day","2 - High: urgent and likely important","High - 15 Days","Immediate - 24 Hrs","Some Production Loss"),
                                                      "High"),
                         prioritydescription = replace(prioritydescription, 
                                                       prioritydescription %in% c("Medium","Routine- Within 2 Weeks","Medium Priority","Moderate/Required","medium - resp 8 hr.","Medium - (7-14 Days)","Normal - (2-7 Days)","PM - (5+ Days)","Medium_2 days","Standard; 4 days","Medium - 1 week","Medium - 45 Days","Medium (4 - 6 hours)","3 - Medium: Important not urgent"),
                                                      "Medium"),
                         prioritydescription = replace(prioritydescription, 
                                                       prioritydescription %in% c("Scheduled","Low","Spare Time","Low- Within 6 Weeks","Time-Materials Quote","low - eval. 24 hrs.","very low - eval. 1 wk","Low - (14-30 Days)","Non critical","Spare Time (8+ hours)","Project - ( 1+ Weeks)","No Production Downtime","Low Priority_Complete This Week","Routine_24 hrs","SCHEDULED PM DUE THIS DAY/WEEK/MONTH","WP - ROUTINE","Low; 6 days","Low - 1 month","5 - Minimal: Not important not urgent","6 - Project Related (Supply Date)","Managed - 1 Yr","Low - 90 Days","Routine","Low (8 - 24 hours)","4 - Low: Minor importance not urgent"),
                                                      "Low"),
                         prioritydescription = replace(prioritydescription, 
                                                       prioritydescription %in% c("unknown","TBD",""," ","2012-06-28 00:00:00.0","-","*TBD","1","System Available"),
                                                       "Other")
                          )
newwo$prioritydescription <- as.character(newwo$prioritydescription)
newwo$prioritydescription [newwo$prioritydescription%in% c("3 - Medium: Important not urgent")] <- "Medium"
#class(newwo$prioritydescription)
view(unique(newwo$prioritydescription))
count(newwo, newwo$prioritydescription)
```


```{r costts}

```
