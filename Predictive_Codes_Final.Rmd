---
title: "Practicum Predictive"
author: "Team"
date: "3/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(tidyverse)
library(lubridate)
library(ggthemes)
library(data.table)
library(scales)
library(forecast)
library(imputeTS)
```

```{r new, cache=T}
newwo = read_csv("workorder_clean.csv", guess_max = 1500000)
```

## Data Manipulations

```{r date}
requested = newwo %>% 
  mutate(yearrequested = year(daterequested),
         monthrequested = month(daterequested),
         dayrequested = day(daterequested)) %>%
  filter(yearrequested < 2020, yearrequested > 2000) %>%
  mutate(ymrequested = make_date(yearrequested, monthrequested),
         ymdrequested = make_date(yearrequested, monthrequested, dayrequested)) %>%
  mutate(yearcompleted = year(actualcompletiondate),
         monthcompleted = month(actualcompletiondate),
         daycompleted = day(actualcompletiondate)) %>%
  filter(yearcompleted < 2020, yearcompleted > 2000) %>%
  mutate(ymcompleted = make_date(yearcompleted, monthcompleted),
         ymdcompleted = make_date(yearcompleted, monthcompleted, daycompleted))

```

```{r priorityts}
priority = requested %>% select(craftdescription, craftgroup, daterequested, datecreated, actualcompletiondate, laststatuschange, currentstatus, prioritydescription, ispreventmaint, ymrequested, ymcompleted) %>%
  filter(currentstatus %in% c("Completed", "Closed")) %>%
  filter(prioritydescription != "OTHER") %>%
  filter(!is.na(daterequested), !is.na(datecreated), !is.na(laststatuschange)) %>%
  mutate(createffi = abs(as.numeric(round((datecreated - daterequested)/3600), digits = 2)),
         totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

priority
```
## Cost Analysis

### 1. Subsets

```{r cost}
zerocost = newwo %>% filter(actualcosts == 0, 
                            currentstatus == "Completed") %>% 
  select(craftgroup, prioritydescription) %>%
  group_by(craftgroup) %>%
  summarize(n = n())

costdata = requested %>% filter(currentstatus %in% c("Completed", "Closed"),
                                !is.na(daterequested), 
                                !is.na(datecreated), 
                                !is.na(laststatuschange)) %>%
  filter(prioritydescription != "OTHER") %>%
  select(actualcosts, craftgroup, daterequested, actualcompletiondate, prioritydescription, ymrequested, ymcompleted) %>% 
  mutate(totaleffi = abs(as.numeric(round((actualcompletiondate - daterequested)/3600), digits = 2)))

zerocost = costdata %>% filter(actualcosts == 0)
nonzerocost = costdata %>% filter(actualcosts != 0)
normalcost = costdata %>% filter(actualcosts < 3500, actualcosts > 0)
mediumcost = costdata %>% filter(actualcosts >= 3500, actualcosts <= 10000)
highcost = costdata %>% filter(actualcosts > 10000)
```

### 2. Regression

```{r costreg}
regall = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = costdata)
summary(regall)

regnonzero = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = nonzerocost)
summary(regnonzero)

regnormal = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = normalcost)
summary(regnormal)

regmedium = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = mediumcost)
summary(regmedium)

reghigh = lm(actualcosts ~ craftgroup + totaleffi + prioritydescription, data = highcost)
summary(reghigh)
```

### 3. Time Series 

#### Functions

```{r MSEfunc}

#The following functions are used to identify the time series method that gives the lowest test MSE

##For Number of Work Orders by Craft Group

COUNT_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)

  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                                       alpha=ts.training.SESmodel$alpha, 
                                       beta=FALSE, 
                                       gamma=ts.training.SESmodel$gamma)

  ts.HWmodel <- HoltWinters(ts, 
                                      alpha=ts.training.HWmodel$alpha, 
                                      beta=ts.training.HWmodel$beta, 
                                      gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
  
}

#For Total Cost of Work Orders in each Craft Group

COST_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=ts.training.SESmodel$gamma)
  ts.HWmodel <- HoltWinters(ts, 
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
              
AVG_TS = function(craftgroup) {
  tsdata = normalcost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(averagecost = mean(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(tsdata$averagecost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  plot(ts, ylab = "Average Cost", main = paste("AVERAGE COST OF", craftgroup))
}
```

```{r predSES}
SES.prediction = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=ts.training.SESmodel$gamma)
  
  forec = forecast(ts.SESmodel, 18)
  SES.plot = plot(ts.SESmodel)
  forecast.plot = plot(forec, main = "Single Exponential Smoothing Forecast for 2019-2020")
  forecast.plot

}
```

```{r predHW}
HW.prediction = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(count = n()) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$count, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$count[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.HWmodel <- HoltWinters(ts,
                             alpha=ts.training.HWmodel$alpha, 
                             beta=ts.training.HWmodel$beta, 
                             gamma=ts.training.HWmodel$gamma)
  
  forec = forecast(ts.HWmodel, 18)
  HW.plot = plot(ts.HWmodel)
  forecast.plot = plot(forec, main = "Holtwinter Seasonality Forecast for 2019-2020")
  list(HW.plot, forecast.plot)
  
}
```

#### 3.1. Time series by requested date to predict number of orders requested

**3.1.1 All Orders for All Crafts**

```{r wocount}
wocount = nonzerocost  %>% group_by(ymrequested) %>% summarize(wocount = n())
```

```{r wocountts}
wocountts = ts(wocount$wocount, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(wocountts)
```

```{r wocountts_testMSE_allcrafts}
train.periods <- 155
test.periods <- length(wocountts) - train.periods
cycle <- 12

wocountts.training <- ts(wocount$wocount[1:train.periods], start = c(2001,1), end = c(2019,8), frequency = 12)

wocountts.training.SESmodel <- HoltWinters(wocountts.training, beta=FALSE)
wocountts.training.HWmodel <- HoltWinters(wocountts.training)

wocountts.SESmodel <- HoltWinters(wocountts,
                          alpha=wocountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=wocountts.training.SESmodel$gamma)
wocountts.HWmodel <- HoltWinters(wocountts, 
                         alpha=wocountts.training.HWmodel$alpha, 
                         beta=wocountts.training.HWmodel$beta, 
                         gamma=wocountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((wocountts.SESmodel$fitted[fit.start:fit.end] - wocountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((wocountts.HWmodel$fitted[fit.start:fit.end] - wocountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_allcrafts}
plot(wocountts.HWmodel)
wocount_2020_HW = forecast(wocountts.HWmodel, 15)
plot(wocount_2020_HW, main = "Holtwinters Forecast for 2019-2020")
```

```{r avgcost_allcraft}
allavgcost = normalcost %>%  
    group_by(ymrequested) %>% 
    summarize(averagecost = mean(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(allavgcost$averagecost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  plot(ts, ylab = "Average Cost", main = "Average Cost of All Crafts")
 ```

**3.1.2 Plumbing** 

```{r wocountts_predict_plumb}
COUNT_COUNT_TS_MSE("PLUMBING/RESTROOM")

HW.prediction("PLUMBING/RESTROOM")

AVG_TS("PLUMBING/RESTROOM")
```

**3.1.3 Furniture** 

```{r wocountts_predict_furniture}
COUNT_TS_MSE("FURNITURES/UTILITIES/APPLIANCES")

HW.prediction("FURNITURES/UTILITIES/APPLIANCES")

AVG_TS("FURNITURES/UTILITIES/APPLIANCES")
```

**3.1.3 Security**

```{r wocountts_predict_security}
COUNT_TS_MSE("HEALTH/SAFETY/SECURITY")

HW.prediction("HEALTH/SAFETY/SECURITY")

AVG_TS("HEALTH/SAFETY/SECURITY")
```

**3.1.4 Electricity/Energy**

```{r wocountts_predict_energy}
COUNT_TS_MSE("ELECTRICITY/ENERGY")

HW.prediction("ELECTRICITY/ENERGY")

AVG_TS("ELECTRICITY/ENERGY")
```

**3.1.5 Outdoors**

```{r wocountts_predict_outdoor}
COUNT_TS_MSE("OUTDOORS")

HW.prediction("OUTDOORS")

AVG_TS("OUTDOORS")
```

**3.1.6 Vehicle/Transportation/Delivery** 

```{r wocountts_predict_transport}
COUNT_TS_MSE("VEHICLE/TRANSPORTATION/DELIVERY")

HW.prediction("VEHICLE/TRANSPORTATION/DELIVERY")

AVG_TS("VEHICLE/TRANSPORTATION/DELIVERY")
```

**3.1.7 Cleaning/Sanitization** 

```{r wocountts_predict_clean}
COUNT_TS_MSE("CLEANING/SANITIZATION")

HW.prediction("CLEANING/SANITIZATION")

AVG_TS("CLEANING/SANITIZATION")
```

**3.1.8 Construction/Building** 

```{r wocountts_predict_construct}
COUNT_TS_MSE("CONSTRUCTION/BUILDING")

HW.prediction("CONSTRUCTION/BUILDING")

AVG_TS("CONSTRUCTION/BUILDING")
```


**3.1.9 Event/Recreation/Food and Beverages**

```{r wocountts_predict_event}
COUNT_TS_MSE("EVENT/RECREATION/F&B")

HW.prediction("EVENT/RECREATION/F&B")

AVG_TS("EVENT/RECREATION/F&B")
```


**3.1.10 Plant and Materials**

```{r wocountts_predict_plant}
COUNT_TS_MSE("PLANT/MATERIALS")

HW.prediction("PLANT/MATERIALS")

AVG_TS("PLANT/MATERIALS")
```

**3.1.11 Personnel and Training**

```{r wocountts_predict_personnel}
COUNT_TS_MSE("ADMIN/PERSONNEL/TRAINING")

HW.prediction("ADMIN/PERSONNEL/TRAINING")

AVG_TS("ADMIN/PERSONNEL/TRAINING")
```

**3.1.12 Preventive/Scheduled** 

```{r wocountts_predict_PM}
COUNT_TS_MSE("PREVENTIVE/SCHEDULED")

HW.prediction("PREVENTIVE/SCHEDULED")

AVG_TS("PREVENTIVE/SCHEDULED")
```

**3.1.13 Inspection** 

```{r wocountts_predict_inspect}
COUNT_TS_MSE("INSPECTION")

HW.prediction("INSPECTION")

AVG_TS("INSPECTION")
```

**3.1.14 IT/Network** 

```{r wocountts_predict_IT}
COUNT_TS_MSE("IT/NETWORK")

HW.prediction("IT/NETWORK")

AVG_TS("IT/NETWORK")
```


**3.1.15 Contract**

```{r wocountts_predict_contract}
COUNT_TS_MSE("CONTRACT")

HW.prediction("CONTRACT")

AVG_TS("CONTRACT")
```

**3.1.16 SOS**

```{r wocountts_predict_SOS}
COUNT_TS_MSE("SOS")

HW.prediction("SOS")

AVG_TS("SOS")
```


**3.1.17 Others** 

```{r wocountts_predict_other}
othercount = nonzerocost %>% filter(craftgroup %in% c("CODES", "OTHER", "UNCLEAR/TBD")) %>% 
  group_by(ymrequested) %>% 
  summarize(wocount = n())
othercountts = ts(othercount$wocount, start = c(2001,4), end = c(2019,6), frequency = 12)
plot(othercountts)
```

```{r wocountts_testMSE_other}
test.periods <- length(othercountts) - train.periods

othercountts.training <- ts(othercount$wocount[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)

othercountts.training.SESmodel <- HoltWinters(othercountts.training, beta=FALSE0, gamma=FALSE)
othercountts.training.DESmodel <- HoltWinters(othercountts.training, gamma=FALSE)
othercountts.training.HWmodel <- HoltWinters(othercountts.training)

othercountts.SESmodel <- HoltWinters(othercountts,
                          alpha=othercountts.training.SESmodel$alpha, 
                          beta=FALSE, 
                          gamma=FALSE)
othercountts.DESmodel <- HoltWinters(othercountts, 
                          alpha=othercountts.training.DESmodel$alpha, 
                          beta=othercountts.training.DESmodel$beta, 
                          gamma=FALSE)
othercountts.HWmodel <- HoltWinters(othercountts, 
                         alpha=othercountts.training.HWmodel$alpha, 
                         beta=othercountts.training.HWmodel$beta, 
                         gamma=othercountts.training.HWmodel$gamma)

data.start <- train.periods + 1
data.end <- train.periods + test.periods

fit.start <- train.periods 
fit.end <- train.periods + test.periods - 1

SES.MSE <- sum((othercountts.SESmodel$fitted[fit.start:fit.end] - othercountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - 1 
fit.end <- train.periods + test.periods - 2

DES.MSE <- sum((othercountts.DESmodel$fitted[fit.start:fit.end] - othercountts[data.start:data.end])^2)/(test.periods)

fit.start <- train.periods - cycle + 1 
fit.end <- train.periods + test.periods - cycle

HW.MSE <- sum((othercountts.HWmodel$fitted[fit.start:fit.end] - othercountts[fit.start:fit.end])^2)/(test.periods)

cat(paste("SES MSE =", SES.MSE, "\nDES MSE =", DES.MSE, "\nHW MSE =", HW.MSE))
```

```{r wocountts_predict_other}
plot(othercountts.HWmodel)
othercount_2020_HW = forecast(othercountts.HWmodel, 15)
plot(othercount_2020_HW, main = "Holtwinters other Forecast for 2019-2020")
```

3.2. Time Series by requested date to predict total costs

```{r setupts}
costts = nonzerocost %>% 
  group_by(ymrequested) %>% 
  summarize(totalcost = sum(actualcosts))

normalcostts = normalcost %>% select(actualcosts, ymrequested)
mediumcostts = mediumcost %>% select(actualcosts, ymrequested)
highcostts = highcost %>% select(actualcosts, ymrequested)
```

```{r costts}
totalts = ts(costts$totalcost, start = c(2001,1), end = c(2019,8), frequency = 12)
plot(totalts)
```

```{r costfunctions}
COST_TS_MSE = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts))%>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)

  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle = 12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE)
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=ts.training.SESmodel$gamma)
  ts.HWmodel <- HoltWinters(ts, 
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  data.start <- train.periods + 1
  data.end <- train.periods + test.periods
  
  fit.start <- train.periods 
  fit.end <- train.periods + test.periods - 1
  
  SES.MSE <- sum((ts.SESmodel$fitted[fit.start:fit.end] - ts[data.start:data.end])^2)/(test.periods)
  
  fit.start <- train.periods - cycle + 1 
  fit.end <- train.periods + test.periods - cycle
  
  HW.MSE <- sum((ts.HWmodel$fitted[fit.start:fit.end] - ts[fit.start:fit.end])^2)/(test.periods)
  
  MSE = data.frame(SES.MSE, DES.MSE, HW.MSE)
  
  print(MSE)
  print(paste("The minimum MSE is", 
              names(MSE)[which.min(MSE)],
              "=",
              round(MSE[which.min(MSE)]))) 
  
}

### SES function for cost

SES.prediction.cost = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts)) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle = 12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.SESmodel <- HoltWinters(ts.training, beta=FALSE, gamma=TRUE)
  
  ts.SESmodel <- HoltWinters(ts,
                             alpha=ts.training.SESmodel$alpha, 
                             beta=FALSE, 
                             gamma=ts.training.SESmodel$gamma)
  
  forec = forecast(ts.SESmodel, 18)
  SES.plot = plot(ts.SESmodel)
  forecast.plot = plot(forec, main = "Single Exponential Smoothing Cost Forecast for 2019-2020")
  list(SES.plot, forecast.plot)
  
}


### HW function for cost

HW.prediction.cost = function(craftgroup) {
  tsdata = nonzerocost %>% filter(craftgroup == !!craftgroup) %>% 
    group_by(ymrequested) %>% 
    summarize(totalcost = sum(actualcosts)) %>%
    full_join(wocount, by = "ymrequested") %>%
    na_replace(fill = 0) %>%
    select(-wocount) %>%
    arrange(ymrequested)
  
  ts = ts(tsdata$totalcost, 
          start = c(2001,1), 
          end = c(2019,6), 
          frequency = 12)
  
  
  train.periods = 155
  test.periods = 67
  cycle=12
  
  ts.training <- ts(tsdata$totalcost[1:train.periods], start = c(2001,1), end = c(2019,6), frequency = 12)
  
  ts.training.HWmodel <- HoltWinters(ts.training)
  
  ts.HWmodel <- HoltWinters(ts,
                            alpha=ts.training.HWmodel$alpha, 
                            beta=ts.training.HWmodel$beta, 
                            gamma=ts.training.HWmodel$gamma)
  
  forec = forecast(ts.HWmodel, 18)
  HW.plot = plot(ts.HWmodel)
  forecast.plot = plot(forec, main = "Holtwinter Seasonality Cost Forecast for 2019-2020")
  list(HW.plot, forecast.plot)
  
}
```

### 4. Priority Time Series

```{r emergency cost}
emergencycost = normalcost %>% filter(prioritydescription=="EMERGENCY") %>% 
                           group_by(ymrequested) %>%
                           summarize(totalcost=sum(actualcosts))%>%
                           select(totalcost, ymrequested) %>% 
                           arrange(ymrequested)

e.cost = ts(emergencycost$totalcost, start = c(2001,1), end = c(2019,6), frequency = 12)
plot(e.cost, main = "Total Cost of Emergency Work Orders")
```

```{r predict emergency cost}
train.emergency = 155
test.emergency = 67
e.cycle = 12

e.cost.training = ts(emergencycost$totalcost[1:train.emergency], start = c(2001,1), end = c(2019,6), freq=e.cycle) 
e.cost.training.SESmodel = HoltWinters(e.cost.training, beta=FALSE)
e.cost.training.HWmodel = HoltWinters(e.cost.training)

e.cost.SESmodel = HoltWinters(e.cost, alpha=e.cost.training.SESmodel$alpha, beta=FALSE, gamma=e.cost.training.SESmodel$gamma)
e.cost.HWmodel = HoltWinters(e.cost, alpha=e.cost.training.HWmodel$alpha, beta=e.cost.training.HWmodel$beta, gamma=e.cost.training.HWmodel$gamma)

e.cost.data.start = train.emergency + 1
e.cost.data.end = train.emergency + test.emergency

e.cost.fit.start = train.emergency
e.cost.fit.end = train.emergency + test.emergency - 1
e.cost.SES.MSE = sum((e.cost.SESmodel$fitted[e.cost.fit.start:e.cost.fit.end] - e.cost[e.cost.data.start:e.cost.data.end])^2) / (test.emergency)

e.cost.fit.start = train.emergency - e.cycle + 1
e.cost.fit.end = train.emergency + test.emergency - e.cycle
e.cost.HW.MSE = sum((e.cost.HWmodel$fitted[e.cost.fit.start:e.cost.fit.end] - e.cost[e.cost.data.start:e.cost.data.end])^2) / (test.emergency)

cat(paste("SES MSE =",e.cost.SES.MSE,"\nHW MSE =",e.cost.HW.MSE))

e.cost.HW.forecast = forecast(e.cost.HWmodel,18)
e.cost.HW.forecast.plot = plot(e.cost.HW.forecast, main = "HW Forecast of Cost of Emergency WO 2020-2021")
view(data.frame(e.cost.HW.forecast))
```

```{r avgcost high}
highcost = normalcost %>% filter(prioritydescription=="HIGH") %>% 
                           group_by(ymrequested) %>%
                           summarize(totalcost=sum(actualcosts))%>%
                           select(totalcost, ymrequested) %>% 
                           arrange(ymrequested)

h.cost = ts(highcost$totalcost, start = c(2001,6), end = c(2019,6), frequency = 12)
plot(h.cost, main = "Cost of High Work Orders")
```
```{r predict high cost}
train.high = 152
test.high = 65
h.cycle = 12

h.cost.training = ts(highcost$totalcost[1:train.high], start = c(2001,6), end = c(2019,6), freq=h.cycle) 
h.cost.training.SESmodel = HoltWinters(h.cost.training, beta=FALSE)
h.cost.training.HWmodel = HoltWinters(h.cost.training)

h.cost.SESmodel = HoltWinters(h.cost, alpha=h.cost.training.SESmodel$alpha, beta=FALSE, gamma=h.cost.training.SESmodel$gamma)
h.cost.HWmodel = HoltWinters(h.cost, alpha=h.cost.training.HWmodel$alpha, beta=h.cost.training.HWmodel$beta, gamma=h.cost.training.HWmodel$gamma)

h.cost.data.start = train.high + 1
h.cost.data.end = train.high + test.high

h.cost.fit.start = train.high
h.cost.fit.end = train.high + test.high - 1
h.cost.SES.MSE = sum((h.cost.SESmodel$fitted[h.cost.fit.start:h.cost.fit.end] - h.cost[h.cost.data.start:h.cost.data.end])^2) / (test.high)

h.cost.fit.start = train.high - h.cycle + 1
h.cost.fit.end = train.high + test.high - h.cycle
h.cost.HW.MSE = sum((h.cost.HWmodel$fitted[h.cost.fit.start:h.cost.fit.end] - h.cost[h.cost.data.start:h.cost.data.end])^2) / (test.high)

cat(paste("SES MSE =",h.cost.SES.MSE,"\nHW MSE =",h.cost.HW.MSE))

h.cost.HW.forecast = forecast(h.cost.HWmodel,18)
h.cost.HW.forecast.plot = plot(h.cost.HW.forecast, main = "HW Forecast of Cost of High WO 2020-2021")
view(summary(h.cost.HW.forecast))
```

```{r medium cost}
mediumcost = normalcost %>% filter(prioritydescription=="MEDIUM") %>%
                           group_by(ymrequested) %>%
                           summarize(totalcost=sum(actualcosts))%>%
                           select(totalcost, ymrequested) %>% 
                           arrange(ymrequested)

m.cost = ts(mediumcost$totalcost, start = c(2001,1), end = c(2019,6), frequency = 12)
plot(m.cost, main = "Cost of Medium Work Orders")
```

```{r predict medium cost}
train.medium = 155
test.medium = 67
m.cycle = 12

m.cost.training = ts(mediumcost$totalcost[1:train.medium], start = c(2001,1), end = c(2019,6), freq=m.cycle) 
m.cost.training.SESmodel = HoltWinters(m.cost.training, beta=FALSE)
m.cost.training.HWmodel = HoltWinters(m.cost.training)

m.cost.SESmodel = HoltWinters(m.cost, alpha=m.cost.training.SESmodel$alpha, beta=FALSE, gamma=m.cost.training.SESmodel$gamma)
m.cost.HWmodel = HoltWinters(m.cost, alpha=m.cost.training.HWmodel$alpha, beta=m.cost.training.HWmodel$beta, gamma=m.cost.training.HWmodel$gamma)

m.cost.data.start = train.medium + 1
m.cost.data.end = train.medium + test.medium

m.cost.fit.start = train.medium
m.cost.fit.end = train.medium + test.medium - 1
m.cost.SES.MSE = sum((m.cost.SESmodel$fitted[m.cost.fit.start:m.cost.fit.end] - m.cost[m.cost.data.start:m.cost.data.end])^2) / (test.medium)

m.cost.fit.start = train.medium - m.cycle + 1
m.cost.fit.end = train.medium + test.medium - m.cycle
m.cost.HW.MSE = sum((m.cost.HWmodel$fitted[m.cost.fit.start:m.cost.fit.end] - m.cost[m.cost.data.start:m.cost.data.end])^2) / (test.medium)

cat(paste("SES MSE =",m.cost.SES.MSE,"\nHW MSE =",m.cost.HW.MSE))

m.cost.HW.forecast = forecast(m.cost.HWmodel,36)
m.cost.HW.forecast.plot = plot(m.cost.HW.forecast, main = "HW Forecast of Cost of Medium WO 2020-2021")
view(summary(m.cost.HW.forecast))
```

```{r low cost}
lowcost = normalcost %>% filter(prioritydescription=="LOW") %>% 
                           group_by(ymrequested) %>%
                           summarize(totalcost=sum(actualcosts))%>%
                           select(totalcost, ymrequested) %>% 
                           arrange(ymrequested)

l.cost = ts(lowcost$totalcost, start = c(2001,1), end = c(2019,6), frequency = 12)
plot(l.cost, main = "Cost of Low Work Orders")
```

```{r predict low cost}
train.low = 157
test.low = 65
l.cycle = 12

l.cost.training = ts(lowcost$totalcost[1:train.low], start = c(2001,1), end = c(2019,6), freq=l.cycle) 
l.cost.training.SESmodel = HoltWinters(l.cost.training, beta=FALSE)
l.cost.training.HWmodel = HoltWinters(l.cost.training)

l.cost.SESmodel = HoltWinters(l.cost, alpha=l.cost.training.SESmodel$alpha, beta=FALSE, gamma=l.cost.training.SESmodel$gamma)
l.cost.HWmodel = HoltWinters(l.cost, alpha=l.cost.training.HWmodel$alpha, beta=l.cost.training.HWmodel$beta, gamma=l.cost.training.HWmodel$gamma)

l.cost.data.start = train.low + 1
l.cost.data.end = train.low + test.low

l.cost.fit.start = train.low
l.cost.fit.end = train.low + test.low - 1
l.cost.SES.MSE = sum((l.cost.SESmodel$fitted[l.cost.fit.start:l.cost.fit.end] - l.cost[l.cost.data.start:l.cost.data.end])^2) / (test.low)

l.cost.fit.start = train.low - l.cycle + 1
l.cost.fit.end = train.low + test.low - l.cycle
l.cost.HW.MSE = sum((l.cost.HWmodel$fitted[l.cost.fit.start:l.cost.fit.end] - l.cost[l.cost.data.start:l.cost.data.end])^2) / (test.low)

cat(paste("SES MSE =",l.cost.SES.MSE,"\nHW MSE =",l.cost.HW.MSE))

l.cost.HW.forecast = forecast(l.cost.HWmodel,18)
l.cost.HW.forecast.plot = plot(l.cost.HW.forecast, main = "HW Forecast of Cost of Low WO 2020-2021")
view(summary(l.cost.HW.forecast))
```
### 5. Efficiency Time Series

1. Request-Created Efficiency

2. Request-Completed Efficiency
